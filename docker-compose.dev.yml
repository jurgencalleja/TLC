# TLC Dev Environment
# Run with: PROJECT_DIR=/path/to/project docker-compose -f docker-compose.dev.yml up
# Container names will be: tlc-{project-name}-{service}

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: tlc-${COMPOSE_PROJECT_NAME:-dev}-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
    ports:
      - "${DB_PORT:-5433}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Your App (runs from project directory)
  app:
    image: node:20-alpine
    container_name: tlc-${COMPOSE_PROJECT_NAME:-dev}-app
    working_dir: /app
    command: >
      sh -c "
        npm install &&
        echo 'Running database migrations...' &&
        (npm run db:push 2>/dev/null || npx drizzle-kit push 2>/dev/null || echo 'No migrations to run') &&
        npm run dev
      "
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgres://postgres:postgres@db:5432/app
      - PORT=5001
      # S3-compatible storage (MinIO)
      - S3_ENDPOINT=http://storage:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=uploads
      - S3_REGION=us-east-1
      - S3_FORCE_PATH_STYLE=true
      - AWS_ENDPOINT_URL_S3=http://storage:9000
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_REGION=us-east-1
    ports:
      - "${APP_PORT:-5001}:5001"
    volumes:
      - ..:/app
      - /app/node_modules
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure

  # Database GUI (pgweb - clean, modern)
  # Note: If using Drizzle/Prisma, run their studios instead:
  #   npx drizzle-kit studio  (port 4983)
  #   npx prisma studio       (port 5555)
  dbadmin:
    image: sosedoff/pgweb:latest
    container_name: tlc-${COMPOSE_PROJECT_NAME:-dev}-dbadmin
    ports:
      - "${DBADMIN_PORT:-8081}:8081"
    environment:
      - PGWEB_DATABASE_URL=postgres://postgres:postgres@db:5432/app?sslmode=disable
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure

  # MinIO S3-Compatible Storage
  storage:
    image: minio/minio:latest
    container_name: tlc-${COMPOSE_PROJECT_NAME:-dev}-storage
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: on-failure

  # TLC Dashboard
  dashboard:
    image: node:20-alpine
    container_name: tlc-${COMPOSE_PROJECT_NAME:-dev}-dashboard
    working_dir: /project
    command: sh -c "cd /tlc/server && npm install && cd /project && node /tlc/server/index.js --proxy-only"
    environment:
      - TLC_PORT=3147
      - TLC_PROXY_ONLY=true
      - TLC_APP_PORT=5001
    ports:
      - "${DASHBOARD_PORT:-3147}:3147"
    volumes:
      - ./server:/tlc/server
      - ..:/project
    depends_on:
      - app
    restart: on-failure

  # Playwright E2E Tests (optional - starts on demand)
  playwright:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    container_name: tlc-${COMPOSE_PROJECT_NAME:-dev}-playwright
    working_dir: /app
    profiles:
      - test
    command: npx playwright test
    environment:
      - BASE_URL=http://app:5001
      - CI=true
    volumes:
      - ..:/app
    depends_on:
      - app

volumes:
  postgres-data:
  minio-data:
