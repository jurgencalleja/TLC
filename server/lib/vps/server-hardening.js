/**
 * Server Hardening Configuration
 * SSH config, sysctl, user management, security limits
 */

/**
 * Generate SSH daemon configuration
 * @param {Object} options - SSH configuration options
 * @param {boolean} [options.passwordAuth=false] - Enable password authentication
 * @param {number} [options.port=22] - SSH port
 * @param {boolean} [options.permitRootLogin=false] - Allow root login
 * @returns {string} SSH configuration
 */
export function generateSshConfig(options = {}) {
  const {
    passwordAuth = false,
    port = 22,
    permitRootLogin = false,
  } = options;

  const lines = [
    '# SSH Server Configuration',
    '# Generated by TLC Server Hardening',
    '',
    `Port ${port}`,
    'Protocol 2',
    '',
    '# Authentication',
    `PasswordAuthentication ${passwordAuth ? 'yes' : 'no'}`,
    'PubkeyAuthentication yes',
    `PermitRootLogin ${permitRootLogin ? 'yes' : 'no'}`,
    'PermitEmptyPasswords no',
    'ChallengeResponseAuthentication no',
    '',
    '# Security',
    'X11Forwarding no',
    'MaxAuthTries 3',
    'LoginGraceTime 60',
    'ClientAliveInterval 300',
    'ClientAliveCountMax 2',
    '',
    '# Logging',
    'SyslogFacility AUTH',
    'LogLevel VERBOSE',
  ];

  return lines.join('\n');
}

/**
 * Generate sysctl kernel parameter configuration
 * @param {Object} options - Sysctl options
 * @returns {string} Sysctl configuration
 */
export function generateSysctlConfig(options = {}) {
  const lines = [
    '# Sysctl Security Configuration',
    '# Generated by TLC Server Hardening',
    '',
    '# Disable IP forwarding',
    'net.ipv4.ip_forward = 0',
    'net.ipv6.conf.all.forwarding = 0',
    '',
    '# Disable source routing',
    'net.ipv4.conf.all.accept_source_route = 0',
    'net.ipv4.conf.default.accept_source_route = 0',
    'net.ipv6.conf.all.accept_source_route = 0',
    '',
    '# Disable ICMP redirects',
    'net.ipv4.conf.all.accept_redirects = 0',
    'net.ipv4.conf.default.accept_redirects = 0',
    'net.ipv4.conf.all.send_redirects = 0',
    'net.ipv4.conf.default.send_redirects = 0',
    '',
    '# Enable SYN flood protection',
    'net.ipv4.tcp_syncookies = 1',
    'net.ipv4.tcp_max_syn_backlog = 2048',
    '',
    '# Enable reverse path filtering',
    'net.ipv4.conf.all.rp_filter = 1',
    'net.ipv4.conf.default.rp_filter = 1',
    '',
    '# Log martian packets',
    'net.ipv4.conf.all.log_martians = 1',
    '',
    '# Ignore ICMP broadcast requests',
    'net.ipv4.icmp_echo_ignore_broadcasts = 1',
    '',
    '# Kernel hardening',
    'kernel.randomize_va_space = 2',
    'kernel.kptr_restrict = 2',
  ];

  return lines.join('\n');
}

/**
 * Generate commands to disable unnecessary services
 * @param {string[]} services - List of services to disable
 * @returns {string[]} Array of systemctl commands
 */
export function disableServices(services = []) {
  const commands = [];

  for (const service of services) {
    commands.push(`systemctl stop ${service}`);
    commands.push(`systemctl disable ${service}`);
    commands.push(`systemctl mask ${service}`);
  }

  return commands;
}

/**
 * Generate unattended-upgrades configuration
 * @param {Object} options - Auto-update options
 * @returns {string} Unattended-upgrades configuration
 */
export function enableAutoUpdates(options = {}) {
  const {
    rebootTime = '02:00',
    autoReboot = false,
  } = options;

  const lines = [
    '// Unattended-Upgrade Configuration',
    '// Generated by TLC Server Hardening',
    '',
    'Unattended-Upgrade::Allowed-Origins {',
    '    "${distro_id}:${distro_codename}";',
    '    "${distro_id}:${distro_codename}-security";',
    '    "${distro_id}ESMApps:${distro_codename}-apps-security";',
    '    "${distro_id}ESM:${distro_codename}-infra-security";',
    '};',
    '',
    'Unattended-Upgrade::Package-Blacklist {',
    '};',
    '',
    `Unattended-Upgrade::Automatic-Reboot "${autoReboot ? 'true' : 'false'}";`,
    `Unattended-Upgrade::Automatic-Reboot-Time "${rebootTime}";`,
    '',
    'Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";',
    'Unattended-Upgrade::Remove-Unused-Dependencies "true";',
  ];

  return lines.join('\n');
}

/**
 * Create a server hardening manager
 * @returns {Object} Server hardening manager with methods
 */
export function createServerHardening() {
  return {
    generateSshConfig,
    generateSysctl: generateSysctlConfig,
    disableServices,
    enableAutoUpdates,

    /**
     * Generate all hardening configurations
     * @param {Object} options - Configuration options
     * @returns {Object} All generated configurations
     */
    generateAll(options = {}) {
      return {
        ssh: generateSshConfig(options.ssh || {}),
        sysctl: generateSysctlConfig(options.sysctl || {}),
        disableCommands: disableServices(options.disableServices || []),
        autoUpdates: enableAutoUpdates(options.autoUpdates || {}),
      };
    },
  };
}
