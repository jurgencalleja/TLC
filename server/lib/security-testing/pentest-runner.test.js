/**
 * Pentest Runner Tests
 */
import { describe, it, expect, vi } from 'vitest';
import { runNuclei, testSqlInjection, testXss, testAuthBypass, generatePentestReport, createPentestRunner } from './pentest-runner.js';

describe('pentest-runner', () => {
  describe('runNuclei', () => {
    it('runs Nuclei scan', async () => {
      const mockExec = vi.fn().mockResolvedValue({ stdout: '[]' });
      const result = await runNuclei({ target: 'http://localhost', exec: mockExec });
      expect(result).toBeDefined();
    });

    it('uses OWASP templates', async () => {
      const mockExec = vi.fn().mockResolvedValue({ stdout: '[]' });
      await runNuclei({ target: 'http://localhost', templates: ['owasp'], exec: mockExec });
      expect(mockExec).toHaveBeenCalledWith(expect.stringContaining('owasp'));
    });
  });

  describe('testSqlInjection', () => {
    it('tests SQL injection', async () => {
      const result = await testSqlInjection({ url: 'http://localhost/api', mockFetch: vi.fn().mockResolvedValue({ text: () => 'error in your SQL syntax' }) });
      expect(result.vulnerable).toBe(true);
    });
  });

  describe('testXss', () => {
    it('tests XSS vulnerabilities', async () => {
      const result = await testXss({ url: 'http://localhost', mockFetch: vi.fn().mockResolvedValue({ text: () => '<script>alert(1)</script>' }) });
      expect(result.vulnerable).toBe(true);
    });
  });

  describe('testAuthBypass', () => {
    it('tests auth bypass', async () => {
      const result = await testAuthBypass({ url: 'http://localhost/admin', mockFetch: vi.fn().mockResolvedValue({ status: 200 }) });
      expect(result.vulnerable).toBe(true);
    });
  });

  describe('generatePentestReport', () => {
    it('generates pentest report', () => {
      const findings = [{ type: 'sqli', severity: 'critical', url: '/api' }];
      const report = generatePentestReport(findings);
      expect(report).toContain('SQL');
      expect(report).toContain('critical');
    });
  });

  describe('createPentestRunner', () => {
    it('creates runner', () => {
      const runner = createPentestRunner();
      expect(runner.scan).toBeDefined();
      expect(runner.testSqli).toBeDefined();
      expect(runner.testXss).toBeDefined();
    });
  });
});
